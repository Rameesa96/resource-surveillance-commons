name: Generate tsserve.auto.ts

on:
  push:
    branches:
      - main  # Adjust this to your main branch name if different
  workflow_dispatch:  # Allows manual triggering

jobs:
  generate-tsserve:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Deno
      uses: denolib/setup-deno@v2
      with:
        deno-version: v1.x

    - name: Run tsserve-gen.ts
      run: deno run --allow-read --allow-net --allow-write --allow-env --allow-run --allow-sys support/bin/tsserve-gen.ts

    - name: Check if tsserve.auto.ts has changed
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add support/bin/tsserve.auto.ts
        if [ -n "$(git status --porcelain)" ]; then
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$GITHUB_REPOSITORY
          git commit -m "chore: re-generate tsserve.auto.ts"
          git push
        else
          echo "No tsserve.auto.ts changes to commit"
